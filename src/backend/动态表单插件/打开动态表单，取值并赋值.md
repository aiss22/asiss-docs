# 打开动态表单，取值并赋值

动态表单新增界面、代码--获取销售出库单列表的值，sql代码--值传递代码--EntityRowDoubleClick事件、双击单据体触发联查--返回数据界面、代码--OnInitialize事件，改变表单标题、字段标题
步骤：

1. 打开销售订单--批量编辑字段属性--菜单合集新增一个按钮（查看出库信息）
2. 点击新建--空白对象--普通动态表单--设置名称、标识
3. 工具箱--放置一个（分割容器）--方向设为纵向--停靠充满
4. 放一个单据体--设置标识、ORM实体名为（F_xx_Entity）--勾选是否显示序号--序号字段标识为（FSeq）--停靠为（充满）--缺省行数设为0
5. 放置6个文本到单据体--分别改名为--FOutBillNo 出库单号--FMsterialNo 物料编码--FMaterialName 物料名称--FQTY 出库数量--FID
6. 点击运行，查看效果
**返回值界面
7. 添加一个复选框--放到最前面--修改标识、名称（选择）
8. 点击菜单集合--添加按钮（返回数据-tbReturnData）--再添加一个按钮（关闭-tbClose）--点击事件--新增操作-关闭
9. 在销售订单上--添加5个文本字段--FMaterialNo 物料编码--FMaterialName 物料名称--FQty1 出库数量--FOutBillNo 出库单号--FOutID 出库ID
**改变表单标题，字段标题（OnInitialize事件）
10. 销售订单新增一个复选框按钮--改名为（是否入库）标识（FIsInStock）

```代码
入口ClassOpen类：
namespace Kingdee.Bos.Project.DyForm
{
    [Description("动态表单插件"), HotUpdate]
    public class ClassOpen:AbstractBillPlugIn
    {
        public override void BarItemClick(BarItemClickEventArgs e)
        {
            base.BarItemClick(e);
            if (e.BarItemKey.Equals("OXCH_Outbill"))
            {
                //调用动态表单
                DynamicFormShowParameter formPa = new DynamicFormShowParameter();

                //调用哪个表单
                formPa.FormId = "OXCH_CKXSCKD";

                //通过销售订单编号，当前打开单据的单据编号查询后台数据
                formPa.CustomParams.Add("FBillNo", Convert.ToString(this.View.Model.GetValue("FBillNo")));
                
                //传递复选框的值
                formPa.CustomParams.Add("FIsInStock",Convert.ToString(this.View.Model.GetValue("FIsInStock")));

                //打开的动态表单，加载进来
                //2种写法，一种直接弹窗，另一种动态接收数据，返回的数据都放在result上面
                //动态取值
                //收类DyFormOutBill,count ==1,把整个数据返回到这里主表
                this.View.ShowForm(formPa,delegate(FormResult result)
                {
                    //定义接收值，转换成(DynamicObjectCollection)类型
                    DynamicObjectCollection returnData = (DynamicObjectCollection)result.ReturnData;

                    //如果不为空，执行
                    if(returnData != null)
                    {
                        //把整个单据，拆分成一行一行，0代表只返回一行
                        DynamicObject entryRow = returnData[0];

                        //把接收回来的5个值赋值
                        this.View.Model.SetValue("FMaterialNo", entryRow["FMaterialNo"]);
                        this.View.Model.SetValue("FMaName", entryRow["FMaterialName"]);
                        this.View.Model.SetValue("FQty1", entryRow["FQty"]);
                        this.View.Model.SetValue("FOutBillNo", entryRow["FOutBillNo"]);
                        this.View.Model.SetValue("FOutID", entryRow["FID"]);
                    }

                });
            }
        }
    }
}
```

```示例
新建DyFormOutBill类
namespace Kingdee.Bos.Project.DyForm
{
    [Description("销售出库单--动态表单插件"),HotUpdate]
    public class DyFormOutBill : AbstractDynamicFormPlugIn
    {
        //接收传回来的数据
        string FBillNo;
        DataTable dt;

        //OnInitialize方法
        public override void OnInitialize(InitializeEventArgs e)
        {
            base.OnInitialize(e);
            //接收值传进来的FIsInStock 是否是入库单
            string FIsInstock = this.View.OpenParameter.GetCustomParameter("FIsInstock").ToString();
            if(FIsInstock =="True")
            {//弹窗，入库单
                //定义一个LocaleValue类型字段
                LocaleValue title = new LocaleValue("采购入库查询");

                this.View.SetFormTitle(title);

                //出库单号的标题，改成入库单号
                this.View.GetControl("FOutBillNo").Text = "入库单号";
                this.View.GetControl("FQty").Text = "采购入库数量";

                //动态赋值，不加载原先的值
                this.View.SendDynamicFormAction(View);

            }
        }

        public override void OnLoad(EventArgs e)
        {//OnLoad加载事件
            base.OnLoad(e);

            //接收传回来的数据
            //FBillNo = this.View.OpenParameter.GetCustomParameter("FBillNo").ToString();
            object param = this.View.OpenParameter.GetCustomParameter("FBillNo");
            if (param == null || string.IsNullOrEmpty(param.ToString()))
            {
                this.View.ShowErrMessage("未传入销售出库单号参数，请检查调用方式");
                return;
            }
            FBillNo = param.ToString();

            //执行sql
            //where FSOORDERNO='{0}'
            string sql = string.Format(@"/*dialect*/select t1.FID,t2.FBILLNO,t3.FNUMBER,t4.FNAME,t1.FREALQTY,FSOORDERNO
                                        from T_SAL_OUTSTOCKENTRY t1
                                        inner join T_SAL_OUTSTOCK t2 
                                        on t1.FID = t2.FID
                                        inner join T_SAL_OUTSTOCKENTRY_R t5
                                        on t1.FENTRYID = t5.FENTRYID
                                        left join T_BD_MATERIAL t3
                                        on t1.FMATERIALID = t3.FMATERIALID
                                        left join T_BD_MATERIAL_L t4
                                        on t1.FMATERIALID = t4.FMATERIALID and t4.FLOCALEID=2052
                                        where FSOORDERNO='{0}'", FBillNo);
            //dt = DBUtils.ExecuteDataSet(this.Context, sql).Tables[0];
            DataSet ds = DBUtils.ExecuteDataSet(this.Context, sql);
            if (ds == null || ds.Tables.Count == 0 || ds.Tables[0].Rows.Count == 0)
            {
                this.View.ShowMessage("未查询到对应的出库单数据，可能单号错误或无数据");
                return;
            }
            dt = ds.Tables[0];

            //大于0，说明取到数了
            if (dt.Rows.Count > 0)
            {
                //给单据体赋值，构造动态表单
                //定义一个单据体，获取动态表单OXCH_CKXSCKD
                Entity entity = this.View.BillBusinessInfo.GetEntity("F_OXCH_Entity");//单据体标识
                //转换成行
                DynamicObjectCollection rows = this.Model.GetEntityDataObject(entity);
                //把加载的数据包，加入到单据体行集合中
                //示例代码，创建一个空的数据包，仅用来演示如何向单据体集合添加新行
                //给单据体赋值，构造动态表单
                for (int i = 0; i < dt.Rows.Count; i++)
                {
                    //每一行的值定义成DynamicObject类型
                    DynamicObject row = new DynamicObject(entity.DynamicObjectType);
                    entity.SeqDynamicProperty.SetValue(row, i + 1);
                    //第i行
                    row["FOutBillNo"] = dt.Rows[i]["FBILLNO"].ToString();
                    row["FMaterialNo"] = dt.Rows[i]["FNUMBER"].ToString();
                    row["FMaterialName"] = dt.Rows[i]["FNAME"].ToString();
                    row["FQTY"] = dt.Rows[i]["FREALQTY"].ToString();
                    row["FID"] = dt.Rows[i]["FID"].ToString();
                    rows.Add(row);
                }

            }
            this.View.UpdateView("OXCH_CKXSCKD");
        }

        //双击表单，弹出查看单据界面
        public override void EntityRowDoubleClick(EntityRowClickEventArgs e)
        {
            base.EntityRowDoubleClick(e);
            //打开单据查看实例
            BillShowParameter para = new BillShowParameter();
            //打开样式
            para.OpenStyle.ShowType = ShowType.NonModal;
            //打开销售出库单，扩展前的唯一标识SAL_OUTSTOCK
            para.FormId = "SAL_OUTSTOCK";
            //打开状态，View，查看
            para.Status = OperationStatus.VIEW;
            //打开哪张单据的FID内码，传递过来，那一行ROW，双击哪一行获取FID，赋值给他
            para.PKey = this.View.Model.GetValue("FID", e.Row).ToString();
            para.ParentPageId = this.View.ParentFormView.PageId;
            this.View.ShowForm(para);
        }

        //点击按钮事件
        //1.获取整个查看销售出库列表
        //2.循环判断，是否选中复选框，行
        //3.new一个新的方法dymat
        //4.如果值没有问题，赋值上去，做一个动态加载
        //5.如果选中一个count ==1,把整个数据返回主表，类ClassOpen里this.View.ShowForm(formPa,delegate()FormResult result)

        public override void BarItemClick(BarItemClickEventArgs e)
        {

            //定义一个计数器
            int count = 0;

            base.BarItemClick(e);

            //当点击返回数据的按钮，如果值没有问题，赋值上去
            if (e.BarItemKey.Equals("tbReturnData"))
            {
                //获取动态表单的值
                //定义一个函数
                //获取动态表单的单据体F_OXCH_Entity
                Entity entity = this.View.BillBusinessInfo.GetEntity("F_OXCH_Entity");
                //转换成单据体的列表集合，一行一行的
                DynamicObjectCollection entityDataObject = this.View.Model.GetEntityDataObject(entity);

                //定义一个接收dymat
                DynamicObjectCollection dymat = new DynamicObjectCollection(entity.DynamicObjectType, null);

                foreach (DynamicObject current in entityDataObject)
                {
                    //复选框FCheckBox,转换成大写
                    //true代表已勾选复选框
                    if (current["FCheckBox"].ToString().ToUpper() == "TRUE")
                    {
                        dymat.Add(current);
                        count++;
                    }
                }
                if (count == 0)
                {
                    this.View.ShowMessage("请选择数据行");
                    return;
                }
                if (count > 1)
                {
                    this.View.ShowMessage("只能选择一行");
                    return;
                }
                if (count == 1)
                {
                    //返回主界面
                    this.View.ReturnToParentWindow(dymat);
                    this.View.Close();
                }
            }
        }
    }
}
```
