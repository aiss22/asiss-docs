# 存储过程

存储过程 = 把一堆 SQL语句 封装成一个“数据库里的方法”

```CREATE
create procedure GetAllUser --创建存储过程，名字叫GetAllUser
AS
begin --begin/end 存储过程的代码范围像C#的{}
select * from T_User
end

EXEC GetAllUser --执行存储过程
go --批处理分隔符
```

```单个参数
create procedure GetUserById --单个参数
  @Id int
  --@Id:参数名
  --int:参数类型
AS
begin
  select *
  from T_User
  where Id=@Id --传进来的@Id作为查询条件
end

EXEC GetUserById 1
go
```

```多个参数
  create procedure GetUserByAgeRange1 --多个参数
    @MinAge int, --最小年龄
    @MaxAge int --最大年龄
AS
begin
select * from T_User
where Age >=@MinAge AND Age <=@MaxAge
order by Age ASC
end

exec GetUserByAgeRange1 20,30
```

```变量
--存储过程里的变量
create procedure GetUserAge
    @Id int
AS
begin
    declare @Age int --DECLARE:声明一个变量，名字 @Age,类型 INT
    select @Age = Age
    from T_User
    where Id=@Id --把查询到的 Age 赋值给变量@Age
    select @Age AS UserAge --把变量的值返回给调用者
end
exec GetUserAge 5
go
```

```if判断
--IF判断
create procedure ChenckUserExist
    @Id INT
AS
BEGIN
    if exists(select 1 from T_User where Id = @Id)
    BEGIN
        select '用户存在' AS Result
    END
    ELSE
    BEGIN
        select '用户不存在' AS Result
    END
END

exec ChenckUserExist 10
go
```

```增
--增 insert
create procedure AddUser
    @UserName NVARCHAR(50),
    @Age INT
AS
BEGIN
    insert into T_User(UserName,Age)
    values(@UserName,@Age)
END

exec AddUser '胡歌',35
select * from T_User
go
```

```改
--改 update
create procedure UpdateUserAge
    @Id int,
    @Age int
AS
BEGIN
    UPDATE T_User
    SET Age = @Age
    where Id = @Id
END

exec UpdateUserAge 4,19
go
```

```删
--删 Delete
create procedure DeleteUser
    @Id int
AS
BEGIN
    delete from T_User
    where Id = @Id
END

exec DeleteUser 1
go
```

```事务
--事务（多条SQL，要么全部成功，要么全部失败）
create procedure DemoTransaction
AS
BEGIN
    BEGIN TRAN --开启事务

    update T_User set Age = Age+1 where Id =1
    update T_User set Age = Age -2 where Id=3
    
    if @@ERROR <> 0
    BEGIN
        rollback tran
        --出错，回滚
        return
    END

    commit tran
    --全部成功，提交
END

exec DemoTransaction
go
```

```错误捕获 try catch
--错误捕获
create procedure DemoTryCatch
AS
BEGIN
    BEGIN TRY
        select 1/0 --故意制造错误
    END try
    BEGIN catch
        select ERROR_MESSAGE() AS ErrorMsg
    END catch
END
exec DemoTryCatch
```
